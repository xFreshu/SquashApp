---
import Layout from '../layouts/Layout.astro';
import type { Player, Match } from '../components/SquashApp.tsx';

// 1. Fetch Data
let players: Player[] = [];
let matches: Match[] = [];
let error = ''

try {
    // In a server-side context, we need to use an absolute URL for fetching
    const baseUrl = Astro.url.origin;
    const playersResponse = await fetch(`${baseUrl}/api/players`);
    const matchesResponse = await fetch(`${baseUrl}/api/matches`);

    if (!playersResponse.ok || !matchesResponse.ok) {
        throw new Error('Nie udało się pobrać danych do statystyk.');
    }

    players = await playersResponse.json();
    matches = await matchesResponse.json();
} catch (e: any) {
    error = e.message;
}


// 2. Calculate Statistics
const stats = players.map(player => {
    const matchesPlayed = matches.filter(m => m.playerOne.id === player.id || m.playerTwo.id === player.id);
    const wins = matches.filter(m => m.winner.id === player.id);
    
    const totalPoints = matchesPlayed.reduce((acc, m) => {
        return acc + (m.playerOne.id === player.id ? m.playerOneScore : m.playerTwoScore);
    }, 0);

    return {
        ...player,
        wins: wins.length,
        matchesPlayed: matchesPlayed.length,
        avgPoints: matchesPlayed.length > 0 ? (totalPoints / matchesPlayed.length).toFixed(2) : "0.00",
    };
}).sort((a, b) => b.wins - a.wins); // Sort by wins

const totalMatchTime = matches.reduce((acc, m) => acc + (m.durationInSeconds || 0), 0);
const avgMatchTimeInSeconds = matches.length > 0 ? totalMatchTime / matches.length : 0;

const formatTime = (seconds: number) => {
    const mins = Math.floor(seconds / 60);
    const secs = Math.round(seconds % 60);
    return `${mins} min ${secs} sek`;
};

const avgMatchTimeFormatted = formatTime(avgMatchTimeInSeconds);
---

<Layout title="Statystyki Graczy">
    <main class="container mx-auto p-4 md:p-8">
        <header class="text-center mb-12">
            <h1 class="text-4xl md:text-5xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-teal-400 to-blue-500">
                Statystyki
            </h1>
            <a href="/" class="text-teal-400 hover:text-teal-300 mt-4 inline-block">&larr; Powrót do strony głównej</a>
        </header>

        {error && <p class="text-red-500 text-center text-lg mb-8">{error}</p>}

        <div class="bg-gray-800 text-white p-6 rounded-lg shadow-lg w-full max-w-4xl mx-auto mb-12">
            <h2 class="text-2xl font-bold mb-4 text-center">Ogólne Statystyki</h2>
            <div class="text-center">
                <p class="text-lg">Średni czas trwania meczu:</p>
                <p class="text-3xl font-bold text-teal-400">{avgMatchTimeFormatted}</p>
            </div>
        </div>

        <div class="bg-gray-800 text-white p-6 rounded-lg shadow-lg w-full max-w-4xl mx-auto">
            <h2 class="text-2xl font-bold mb-4 text-center">Ranking Graczy</h2>
            <div class="overflow-x-auto">
                <table class="w-full text-left">
                    <thead>
                        <tr class="border-b border-gray-600">
                            <th class="p-4">Gracz</th>
                            <th class="p-4 text-center">Wygrane</th>
                            <th class="p-4 text-center">Rozegrane Mecze</th>
                            <th class="p-4 text-center">Śr. Punkty / Mecz</th>
                        </tr>
                    </thead>
                    <tbody>
                        {stats.map(player => (
                            <tr class="border-b border-gray-700 hover:bg-gray-700">
                                <td class="p-4 font-bold">{player.name}</td>
                                <td class="p-4 text-center text-2xl text-yellow-400">{player.wins}</td>
                                <td class="p-4 text-center">{player.matchesPlayed}</td>
                                <td class="p-4 text-center">{player.avgPoints}</td>
                            </tr>
                        ))}
                        {stats.length === 0 && (
                            <tr>
                                <td colspan="4" class="text-center p-8 text-gray-400">Brak danych do wyświetlenia. Rozegraj pierwszy mecz!</td>
                            </tr>
                        )}
                    </tbody>
                </table>
            </div>
        </div>
    </main>
</Layout>
